name: Worker Auto-Updater

on:
  schedule:
    - cron: '0 18 * * *'  # UTCæ—¶é—´18:00 = åŒ—äº¬æ—¶é—´æ¬¡æ—¥02:00
  workflow_dispatch:
    inputs:
      update_mode:
        description: 'æ›´æ–°æ¨¡å¼ (ç•™ç©ºåˆ™ä½¿ç”¨ä¸Šæ¬¡é…ç½®)'
        required: false
        default: ''
        type: choice
        options:
        - è‡ªåŠ¨
        - æ‰‹åŠ¨
      release_channel:
        description: 'å‘å¸ƒæ¸ é“ (ç•™ç©ºåˆ™ä½¿ç”¨ä¸Šæ¬¡é…ç½®)'
        required: false
        default: ''
        type: choice
        options:
        - ç¨³å®šç‰ˆ
        - æµ‹è¯•ç‰ˆ
      deobfuscate:
        description: 'åæ··æ·†ä»£ç  (ç•™ç©ºåˆ™ä½¿ç”¨ä¸Šæ¬¡é…ç½®)'
        required: false
        default: ''
        type: choice
        options:
        - 'true'
        - 'false'

env:
  REPO_URL: https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases
  INSTALL_DIR: .
  DEFAULT_UPDATE_MODE: 'è‡ªåŠ¨'
  DEFAULT_RELEASE_CHANNEL: 'ç¨³å®šç‰ˆ'
  DEFAULT_DEOBFUSCATE: 'true'

jobs:
  update-worker:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    
    steps:
    # 1. åˆå§‹åŒ–ç¯å¢ƒ
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    # 2. é…ç½®ç›®å½•ç®¡ç†
    - name: åˆ›å»ºé…ç½®ç›®å½•
      run: mkdir -p .github/workflows

    - name: æ¢å¤ä¸Šæ¬¡é…ç½®
      id: restore-config
      continue-on-error: true
      uses: actions/cache@v3
      with:
        path: .github/workflows/last_config.json
        key: worker-config-${{ github.repository }}

    # 3. å‚æ•°å¤„ç†å™¨
    - name: é…ç½®å‚æ•°å¤„ç†
      id: config-processor
      run: |
        # åˆå§‹åŒ–é»˜è®¤å€¼
        CONFIG_UPDATE_MODE="$DEFAULT_UPDATE_MODE"
        CONFIG_RELEASE_CHANNEL="$DEFAULT_RELEASE_CHANNEL"
        CONFIG_DEOBFUSCATE="$DEFAULT_DEOBFUSCATE"

        # å°è¯•è¯»å–ç¼“å­˜é…ç½®
        if [ -f ".github/workflows/last_config.json" ]; then
          echo "æ‰¾åˆ°ç¼“å­˜é…ç½®"
          CACHE_UPDATE_MODE=$(jq -r '.update_mode // empty' .github/workflows/last_config.json 2>/dev/null || echo "")
          CACHE_RELEASE_CHANNEL=$(jq -r '.release_channel // empty' .github/workflows/last_config.json 2>/dev/null || echo "")
          CACHE_DEOBFUSCATE=$(jq -r '.deobfuscate // empty' .github/workflows/last_config.json 2>/dev/null || echo "")
          
          [ -n "$CACHE_UPDATE_MODE" ] && CONFIG_UPDATE_MODE="$CACHE_UPDATE_MODE"
          [ -n "$CACHE_RELEASE_CHANNEL" ] && CONFIG_RELEASE_CHANNEL="$CACHE_RELEASE_CHANNEL"
          [ -n "$CACHE_DEOBFUSCATE" ] && CONFIG_DEOBFUSCATE="$CACHE_DEOBFUSCATE"
        fi

        # å¤„ç†æ‰‹åŠ¨è¾“å…¥çš„å‚æ•°
        [ -n "${{ inputs.update_mode }}" ] && CONFIG_UPDATE_MODE="${{ inputs.update_mode }}"
        [ -n "${{ inputs.release_channel }}" ] && CONFIG_RELEASE_CHANNEL="${{ inputs.release_channel }}"
        [ -n "${{ inputs.deobfuscate }}" ] && CONFIG_DEOBFUSCATE="${{ inputs.deobfuscate }}"

        # ç¡®ä¿ç›®å½•å­˜åœ¨
        mkdir -p .github/workflows

        # ç”Ÿæˆæ–°é…ç½®
        jq -n \
          --arg um "$CONFIG_UPDATE_MODE" \
          --arg rc "$CONFIG_RELEASE_CHANNEL" \
          --arg dob "$CONFIG_DEOBFUSCATE" \
          '{update_mode: $um, release_channel: $rc, deobfuscate: $dob}' > .github/workflows/last_config.json

        # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
        echo "UPDATE_MODE=$CONFIG_UPDATE_MODE" >> $GITHUB_ENV
        echo "RELEASE_CHANNEL=$CONFIG_RELEASE_CHANNEL" >> $GITHUB_ENV
        echo "DEOBFUSCATE=$CONFIG_DEOBFUSCATE" >> $GITHUB_ENV

        echo "æœ€ç»ˆé…ç½®ï¼š"
        echo "UPDATE_MODE=$CONFIG_UPDATE_MODE"
        echo "RELEASE_CHANNEL=$CONFIG_RELEASE_CHANNEL"
        echo "DEOBFUSCATE=$CONFIG_DEOBFUSCATE"

    # 4. æ ¸å¿ƒå·¥ä½œæµç¨‹
    - name: è®¾ç½®ç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests semver jsbeautifier

    - name: æ¸…ç†æ—§æ–‡ä»¶
      run: |
        if [ -f "_worker.js" ]; then
          rm -f _worker.js
          echo "å·²æ¸…ç†æ—§ç‰ˆworkeræ–‡ä»¶"
        fi

    - name: è·å–å½“å‰ç‰ˆæœ¬ä¿¡æ¯
      id: get-current-version
      run: |
        if [ -f "README.md" ]; then
          CURRENT_VERSION=$(grep -oP '(?<=ç‰ˆæœ¬å·: `)[^`]+' README.md | head -1 || echo "")
          LAST_UPDATE_TIME=$(grep -oP '(?<=æ›´æ–°æ—¶é—´: `)[^`]+' README.md | head -1 || echo "")
          echo "CURRENT_VERSION=$CURRENT_VERSION" >> $GITHUB_ENV
          echo "LAST_UPDATE_TIME=$LAST_UPDATE_TIME" >> $GITHUB_ENV
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"
          echo "æœ€åæ›´æ–°æ—¶é—´: $LAST_UPDATE_TIME"
        else
          echo "CURRENT_VERSION=" >> $GITHUB_ENV
          echo "LAST_UPDATE_TIME=" >> $GITHUB_ENV
          echo "æ²¡æœ‰æ‰¾åˆ°READMEæ–‡ä»¶ï¼Œé¦–æ¬¡è¿è¡Œ"
        fi

    - name: è·å–å‘å¸ƒä¿¡æ¯
      id: get-release
      env:
        CHANNEL: ${{ env.RELEASE_CHANNEL == 'ç¨³å®šç‰ˆ' && 'stable' || 'prerelease' }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        import os
        import requests
        import semver
        import sys
        
        headers = {'Authorization': f"Bearer {os.getenv('GITHUB_TOKEN')}"}
        
        try:
            response = requests.get(os.getenv('REPO_URL'), headers=headers)
            response.raise_for_status()
            releases = response.json()
            
            # è¿‡æ»¤å‘å¸ƒæ¸ é“
            filtered_releases = []
            channel = os.getenv('CHANNEL')
            for r in releases:
                if channel == 'stable' and not r['prerelease']:
                    filtered_releases.append(r)
                elif channel == 'prerelease' and r['prerelease']:
                    filtered_releases.append(r)
            
            if not filtered_releases:
                print("::notice::æ²¡æœ‰å¯ç”¨æ›´æ–°")
                # è®¾ç½®è¾“å‡ºå˜é‡
                with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                    f.write(f"has_update=false\n")
                    f.write(f"version=none\n")
                sys.exit(0)

            # ç‰ˆæœ¬æ’åº
            def get_version(release):
                try:
                    tag = release['tag_name'].lstrip('v')
                    return semver.VersionInfo.parse(tag)
                except:
                    return semver.VersionInfo.parse("0.0.0")
            
            filtered_releases.sort(key=get_version, reverse=True)
            latest = filtered_releases[0]
            
            js_asset = next((a for a in latest['assets'] if a['name'].endswith('.js')), None)
            
            if not js_asset:
                print("::warning::æœªæ‰¾åˆ°JSæ–‡ä»¶")
                with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                    f.write(f"has_update=false\n")
                    f.write(f"version=none\n")
                sys.exit(0)

            # æ£€æŸ¥æ˜¯å¦æœ‰æ–°ç‰ˆæœ¬
            current_version = os.getenv('CURRENT_VERSION', '')
            new_version = latest['tag_name']
            
            if current_version == new_version:
                print(f"::notice::å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬: {new_version}")
                # è®¾ç½®æ ‡è®°è¡¨ç¤ºæ²¡æœ‰æ›´æ–°
                with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                    f.write(f"has_update=false\n")
                    f.write(f"version={new_version}\n")
                    f.write(f"asset_url={js_asset['browser_download_url']}\n")
            else:
                print(f"::notice::å‘ç°æ–°ç‰ˆæœ¬: {current_version} -> {new_version}")
                with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                    f.write(f"has_update=true\n")
                    f.write(f"version={new_version}\n")
                    f.write(f"asset_url={js_asset['browser_download_url']}\n")

        except Exception as e:
            print(f"::error::è·å–å‘å¸ƒå¤±è´¥: {str(e)}")
            sys.exit(1)
      shell: python

    - name: ä¸‹è½½å¹¶å¤„ç†ä»£ç 
      if: steps.get-release.outputs.has_update == 'true'
      env:
        DEOBFUSCATE: ${{ env.DEOBFUSCATE }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        import requests
        import jsbeautifier
        import os

        headers = {'Authorization': f"Bearer {os.getenv('GITHUB_TOKEN')}"}
        asset_url = '${{ steps.get-release.outputs.asset_url }}'
        response = requests.get(asset_url, headers=headers)
        response.raise_for_status()
        
        code = response.text
        
        if os.getenv('DEOBFUSCATE') == 'true':
            print("æ­£åœ¨åæ··æ·†ä»£ç ...")
            try:
                code = jsbeautifier.beautify(code)
                print("åæ··æ·†å®Œæˆ")
            except Exception as e:
                print(f"::warning::åæ··æ·†å¤±è´¥: {str(e)}")
        
        with open('_worker.js', 'w', encoding='utf-8') as f:
            f.write(code)
            print("æ–‡ä»¶ä¿å­˜æˆåŠŸ")
      shell: python

    # 5. æ–‡æ¡£æ›´æ–° - åªæœ‰åœ¨æœ‰æ–°ç‰ˆæœ¬æ—¶æ‰æ›´æ–°README
    - name: æ›´æ–°READMEæ–‡æ¡£
      if: steps.get-release.outputs.has_update == 'true'
      run: |
        # è½¬æ¢å‚æ•°ä¸ºURLå®‰å…¨æ ¼å¼
        UPDATE_MODE_URL=$(echo "${{ env.UPDATE_MODE }}" | sed 's/ /%20/g')
        RELEASE_CHANNEL_URL=$(echo "${{ env.RELEASE_CHANNEL }}" | sed 's/ /%20/g')
        DEOBFUSCATE_URL=$(echo "${{ env.DEOBFUSCATE }}" | tr '[:upper:]' '[:lower:]')
        
        # è·å–å½“å‰åŒ—äº¬æ—¶é—´
        UPDATE_TIME=$(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S')
        echo "æ›´æ–°READMEï¼Œæ›´æ–°æ—¶é—´: $UPDATE_TIME"

        # åˆ›å»ºREADMEæ–‡ä»¶
        echo "# ğŸ“¦ Worker è‡ªåŠ¨æ›´æ–°ç³»ç»Ÿ" > README.md
        echo "" >> README.md
        # é¡¶éƒ¨çŠ¶æ€å¾½ç« 
        echo "[![ç‰ˆæœ¬](https://img.shields.io/badge/ç‰ˆæœ¬-${{ steps.get-release.outputs.version }}-blue)]()" >> README.md
        echo "[![æ¨¡å¼](https://img.shields.io/badge/æ¨¡å¼-$UPDATE_MODE_URL-yellow)]()" >> README.md
        echo "[![æ¸ é“](https://img.shields.io/badge/æ¸ é“-$RELEASE_CHANNEL_URL-green)]()" >> README.md
        echo "[![åæ··æ·†](https://img.shields.io/badge/åæ··æ·†-$DEOBFUSCATE_URL-red)]()" >> README.md
        echo "" >> README.md
        
        echo "## ğŸš€ åŠŸèƒ½æ¦‚è¿°" >> README.md
        echo "- è‡ªåŠ¨æ£€æŸ¥å¹¶æ›´æ–°Workerè„šæœ¬" >> README.md
        echo "- æ”¯æŒå®šæ—¶å’Œæ‰‹åŠ¨è§¦å‘æ›´æ–°" >> README.md
        echo "- åŒæ¸ é“æ›´æ–°ï¼ˆç¨³å®šç‰ˆ/æµ‹è¯•ç‰ˆï¼‰" >> README.md
        echo "- è‡ªåŠ¨ä»£ç åæ··æ·†å¤„ç†" >> README.md
        echo "- **æ™ºèƒ½é…ç½®è®°å¿†** - è‡ªåŠ¨è®°ä½ä¸Šæ¬¡çš„å‚æ•°é€‰æ‹©" >> README.md
        echo "" >> README.md
        
        echo "## ğŸ“– ä½¿ç”¨è¯´æ˜" >> README.md
        echo "### ğŸ¤– è‡ªåŠ¨æ¨¡å¼" >> README.md
        echo "- æ¯æ—¥åŒ—äº¬æ—¶é—´02:00è‡ªåŠ¨æ£€æŸ¥æ›´æ–°" >> README.md
        echo "- ä½¿ç”¨ä¸Šæ¬¡ç¼“å­˜çš„å·¥ä½œå‚æ•°é…ç½®" >> README.md
        echo "" >> README.md
        
        echo "### ğŸ‘† æ‰‹åŠ¨æ¨¡å¼" >> README.md
        echo "1. è¿›å…¥GitHub Actionsé¡µé¢" >> README.md
        echo "2. é€‰æ‹©\"Worker Auto-Updater\"å·¥ä½œæµ" >> README.md
        echo "3. ç‚¹å‡»\"Run workflow\"å¹¶é€‰æ‹©å‚æ•°ï¼š" >> README.md
        echo "   - æ›´æ–°æ¨¡å¼ï¼ˆè‡ªåŠ¨/æ‰‹åŠ¨ï¼‰" >> README.md
        echo "   - å‘å¸ƒæ¸ é“ï¼ˆç¨³å®šç‰ˆ/æµ‹è¯•ç‰ˆï¼‰" >> README.md
        echo "   - æ˜¯å¦åæ··æ·†ä»£ç ï¼ˆtrue/falseï¼‰" >> README.md
        echo "   > ğŸ’¡ ç•™ç©ºå‚æ•°å°†ä½¿ç”¨ä¸Šæ¬¡é…ç½®" >> README.md
        echo "" >> README.md
        
        echo "## ğŸ” å½“å‰çŠ¶æ€" >> README.md
        echo "### ğŸ› ï¸ æœ€æ–°æ›´æ–°" >> README.md
        echo "- ğŸ·ï¸ **ç‰ˆæœ¬å·**: \`${{ steps.get-release.outputs.version }}\`" >> README.md
        echo "- ğŸ•’ **æ›´æ–°æ—¶é—´**: \`$UPDATE_TIME\` (åŒ—äº¬æ—¶é—´)" >> README.md
        echo "- âš™ï¸ **æ›´æ–°æ¨¡å¼**: \`${{ env.UPDATE_MODE }}\`" >> README.md
        echo "- ğŸŒ¿ **å‘å¸ƒæ¸ é“**: \`${{ env.RELEASE_CHANNEL }}\`" >> README.md
        echo "- ğŸ”§ **åæ··æ·†**: \`${{ env.DEOBFUSCATE }}\`" >> README.md
        echo "" >> README.md
        
        echo "> âœ… **æ›´æ–°çŠ¶æ€**: å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬" >> README.md
        echo "" >> README.md

    # 6. æäº¤å˜æ›´ - åªæœ‰åœ¨æœ‰æ–°ç‰ˆæœ¬æ—¶æ‰æäº¤
    - name: æäº¤æ›´æ–°
      if: steps.get-release.outputs.has_update == 'true'
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        
        git add _worker.js README.md
        if git diff-index --quiet HEAD --; then
          echo "æ²¡æœ‰å˜æ›´éœ€è¦æäº¤"
        else
          git commit -m "ğŸ”§ æ›´æ–°workeråˆ°${{ steps.get-release.outputs.version }} [æ¨¡å¼:${{ env.UPDATE_MODE }}]"
          git push
        fi

    # 7. æŒä¹…åŒ–é…ç½®
    - name: ä¿å­˜å½“å‰é…ç½®
      uses: actions/cache@v3
      with:
        path: .github/workflows/last_config.json
        key: worker-config-${{ github.repository }}

    # 8. å®Œæˆé€šçŸ¥
    - name: è¾“å‡ºå®ŒæˆçŠ¶æ€
      run: |
        if [ "${{ steps.get-release.outputs.has_update }}" = "true" ]; then
          echo "âœ… æ›´æ–°å®Œæˆ: å·²å‡çº§åˆ°ç‰ˆæœ¬ ${{ steps.get-release.outputs.version }}"
        else
          echo "â„¹ï¸ æ— æ›´æ–°: å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ ${{ steps.get-release.outputs.version }}"
        fi
